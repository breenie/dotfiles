#!/bin/bash

set -o pipefail
set -u

function usage {
    echo $"Usage: $0 {ssh|start|stop|refresh}"
    exit 1
}

IF_HOME="${HOME}/Projects/intofilm"
VAGRANT_CWD=${IF_HOME}/src/highlander
BUNDLE=${IF_HOME}/bundles/intofilm.sparsebundle

vagrant() {
  local ACTION=$1
  export VAGRANT_CWD=${VAGRANT_CWD}
  /usr/local/bin/vagrant ${ACTION}
}

refresh() {
    NOW=$(date +"%Y%m%d")
    WD=${HOME}/Downloads

    # These should probably use ~/.my.cnf then we can read stdout again 8).
    DBNAME=filmclub_dev
    DB_HOST=10.0.0.2
    DB_USER=root
    DB_PASS=root

    anonymous download www_filmclub --no-interaction --working-dir=${WD}
    unzip "${WD}/www_filmclub--${NOW}.zip" -d ${WD}
    echo "drop database ${DBNAME};" | mysql -u ${DB_USER} -p${DB_PASS} -h ${DB_HOST} > /dev/null 2>&1
    echo "create database ${DBNAME} charset UTF8;" | mysql -u ${DB_USER} -p${DB_PASS} -h ${DB_HOST} > /dev/null 2>&1
    pv "${WD}/www_filmclub--${NOW}.sql" | mysql -u ${DB_USER} -p${DB_PASS} -h ${DB_HOST} ${DBNAME} > /dev/null 2>&1
    rm -f "${WD}/www_filmclub--${NOW}.*"
}

mount() {
    hdiutil mount ${BUNDLE} >/dev/null 2>&1
}

unmount() {
    diskutil eject /Volumes/intofilm/
}

action=${1:-}
case "${action}" in
    start)
        vagrant up
        ;;

    stop)
        vagrant suspend
        ;;

    vagrant)
      vagrant ${2:-status}
      ;;

    refresh)
        refresh
        ;;
    *)
      usage
esac
